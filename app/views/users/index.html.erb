<h2 class="title-index">New users - Verify and approve!</h2>
<div class="verify-and-approve">

  <table>
    <thead>
      <tr>
        <th>Users</th>
        <th>Approved</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
  <% @unapproved_users.each do |user| %>
    <tr>
      <td><%= user.first_name %> <%= user.last_name %></td>
      <td><%= user.approved? ? 'Yes' : 'No' %></td>
      <td>
        <%= link_to user_path(user) do %>
          <button class="gradient-button">PROFILE</button>
        <% end %>
        <%= button_tag 'Approve', id: "approve-button-#{user.id}", data: { user_id: user.id }, class: 'gradient-button' %>

        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const approveButton<%= user.id %> = document.getElementById('approve-button-<%= user.id %>');
            console.log(approveButton<%= user.id %>);
            if (approveButton<%= user.id %>) {
              approveButton<%= user.id %>.addEventListener('click', () => {
                const userId = approveButton<%= user.id %>.dataset.userId;

                fetch(`/users/${userId}/approve`, {
                  method: 'PATCH',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                  },
                  body: JSON.stringify({ /* Optional: Any additional data you want to send */ })
                })
                .then(response => {
                  if (!response.ok) {
                    throw new Error('Network response was not ok');
                  }
                  return response.json();
                })
                .then(data => {
                  // Handle success response
                  console.log('User approval successful:', data);
                  // Optionally update UI or show a success message
                  approveButton<%= user.id %>.remove();
                })
                .catch(error => {
                  // Handle error
                  console.error('Error approving user:', error);
                  // Optionally show an error message to the user
                });
              });
            }
          });
        </script>
      </td>
    </tr>
  <% end %>

    </tbody>
  </table>
</div>



<div class="search-bar">
  <div class="row justify-content-center">
    <div class="col-sm-8 my-3">
      <%= form_with url: users_path, method: :get, class: "d-flex" do %>
        <%= text_field_tag :query, params[:query], class: "form-control", placeholder: "Type a name or postcode" %>
        <%= text_field_tag :postcode, params[:postcode], class: "form-control mx-2", placeholder: "Type a postcode" %>
        <%= text_field_tag :competencies, params[:competencies], class: "form-control mx-2", placeholder: "Competencies (comma-separated)" %>
        <%= select_tag :driver, options_for_select([['Driver', ''], ['Yes', true], ['No', false]], params[:driver]), class: "form-control mx-2" %>
        <%= select_tag :sponsor, options_for_select([['Sponsor', ''], ['Primary', 'primary'], ['Secondary', 'secondary']], params[:sponsor]), class: "form-control mx-2" %>
        <%= text_field_tag :location, params[:location], class: "form-control mx-2", placeholder: "Type a location" %>
        <%= text_field_tag :distance, params[:distance], class: "form-control mx-2", placeholder: "Distance (km)" %>
        <%= submit_tag "Search", class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>
</div>


<div class="users">
  <% @users.each do |user| %>
    <%= user.last_name %> <%= user.first_name %>
    <br>
  <% end %>
</div>
