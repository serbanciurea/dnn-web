<div class="search-bar">
  <div class="row">
    <div class="col-sm-8">
      <%= form_with url: users_path, method: :get, class: "d-flex" do %>
        <%= text_field_tag :query, params[:query], class: "form-control", placeholder: "Type a name or postcode" %>
        <%= text_field_tag :postcode, params[:postcode], class: "form-control", placeholder: "Type a postcode" %>
        <%= text_field_tag :competencies, params[:competencies], class: "form-control", placeholder: "Competencies (comma-separated)" %>
        <%= select_tag :driver, options_for_select([['Driver', ''], ['Yes', true], ['No', false]], params[:driver]), class: "form-control" %>
        <%= select_tag :sponsor, options_for_select([['Sponsor', ''], ['Primary', 'primary'], ['Secondary', 'secondary']], params[:sponsor]), class: "form-control" %>
        <%= text_field_tag :location, params[:location], class: "form-control", placeholder: "Type a location" %>
        <%= text_field_tag :distance, params[:distance], class: "form-control", placeholder: "Distance (km)" %>
        <%= submit_tag "Search", class: "btn-primary" %>
      <% end %>
    </div>
  </div>
</div>

<div class="users">
  <% @users.each do |user| %>
    <div class="user-item">
      <div class="user-info">
        <%= link_to "#{user.last_name}, #{user.first_name}", user_path(user), class: "user-link" %>
      </div>
      <button class="gradient-button" data-user-id="<%= user.id %>" data-job-id="<%= @job.id %>">Send Email</button>
    </div>
  <% end %>
</div>

<!-- Button to send email to all users -->
<div class="send-email-all">
  <button id="gradient-button" class="gradient-button">Send Email Message to All Users</button>
</div>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.send-email-button').forEach(button => {
      button.addEventListener('click', (event) => {
        const btn = event.target;
        const userId = btn.getAttribute('data-user-id');
        const jobId = btn.getAttribute('data-job-id');

        fetch(`/jobs/${jobId}/send_email_to_user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
          },
          body: JSON.stringify({ user_id: userId, job_id: jobId })
        })
        .then(response => response.json())
        .then(data => {
          btn.textContent = 'Email Sent';
          btn.style.backgroundColor = 'transparent'; // Green color
          btn.disabled = true; // Optionally disable the button
        })
        .catch(error => console.error('Error:', error));
      });
    });

    document.getElementById('send-email-all-button')?.addEventListener('click', () => {
      // Implement logic to send email to all users if needed
      alert('Email message sent to all selected users');
    });
  });

</script>



<%# javascript to show 'sent email' after the button 'send email' has been clicked  %>
<%# <script>
    // app/javascript/packs/application.js (or wherever you handle JavaScript)

  document.addEventListener('DOMContentLoaded', () => {
    // Handle single user email button
    document.querySelectorAll('.gradient-button').forEach(button => {
      button.addEventListener('click', (event) => {
        const btn = event.target;
        btn.textContent = 'Email Sent';
        btn.style.backgroundColor = 'transparent'; // Green color
        btn.disabled = true; // Optionally disable the button
      });
    });

    // Handle "Send Email Message to All Users" button
    document.getElementById('gradient-button')?.addEventListener('click', () => {
      // Implement sending email to all users logic here
      alert('Email message sent to all selected users');
      // Alternatively, you could make an AJAX request here to handle this server-side
    });
  });

</script> %>
